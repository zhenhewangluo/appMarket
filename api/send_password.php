<?php	/************************************************************	 *   Interface 20 for BajieV2     *   send_password.php 	 *	 *   Author: Li Xiaan	 *   Create Time: 2010-05-15	 *   Updates: 	 * 	 *************************************************************/	require("./inc/init.php");	require("./class/smtp.class.php");      //  require_once './PHPMailer/class.phpmailer.php';    if($AM_CURRENT_REQUEST["PROTO"] != 24){		debug($AM_CURRENT_REQUEST);		echo error2json("E002");		die;	}	if(!isset($_POST['email']) || empty($_POST['email'])){		echo error2json("E198");		die;	}		$email = stopSql(__getPost('email'));	if(!is_mail_valid($email)){		echo error2json("E198");		die;	}		//check email.	$conn = connect_comm_db();	if($conn === FALSE){		echo error2json("S100");		die;	}	//$sql = "select am_user.*,am_user_info.user_info_email,am_user_info.user_info_phone,am_user_info.user_info_name from am_user,am_user_info where am_user.user_id=am_user_info.user_id and am_user_info.user_info_email='". $email ."'";	$sql = "select id,email,name from am_registered_user where email='".$email."'";	$rs = mysql_query($sql, $conn);	if($rs === FALSE){		log_message($sql, 'S');		echo error2json("S002");		die;	}		//user not found	if(mysql_num_rows($rs) == 0){		echo error2json("E130");		die;	}	$row = mysql_fetch_assoc($rs);	$reset_user_id = $row["id"];		//generate the reset-code	$reset_time  = time();	//valid period is 10 days.	$expire_time = $reset_time + 86400*10;	$reset_code  = md5($reset_time + intval($reset_user_id));	//$sql = sprintf("insert into am_reset_passwd (user_id, reset_code, create_time, expire_time, status) values (%s, '%s', '%s', '%s', 1)", $reset_user_id, $reset_code, date("Y-m-d H:i:s", $reset_time), date("Y-m-d", $expire_time));	$sql = sprintf("insert into `_kid_ucenter`.`uc_reset_passwd` (uid, reset_code, create_time, expire_time, status) values (%s, '%s', '%s', '%s', 1)", $reset_user_id, $reset_code, date("Y-m-d H:i:s", $reset_time), date("Y-m-d", $expire_time));	if(mysql_query($sql, $conn) === FALSE){		log_message($sql, 'S');		echo error2json("S002");		die;	}				//insert successfully	$inserted_reset_pwd_id = mysql_insert_id();	// subject & content	$subject = '';	$content = '';	$subject = '密码重置确认（系统自动生成-请勿回复此邮件）';	// encoding	$subject = iconv("UTF-8","gb2312",$subject);	$content = file_get_contents("./templates/mail.chn.html");	$nick = empty($row["name"]) ? $email : $row["name"];	$content = str_replace("{{user_name}}",  $nick, $content);	$content = str_replace("{{reset_code}}", $reset_code, $content);	$content = str_replace("{{expire_date}}", date("Y-m-d", $expire_time), $content);	// encoding	$content = iconv("UTF-8","gb2312",$content);	$log_msg = sprintf("reset_id=%s,user_id=%s,email=%s", $inserted_reset_pwd_id, $reset_user_id, $email);	$smtpemailto = trim($email);	$mailtype = "HTML";//邮件格式（HTML/TXT）,TXT为文本邮件	$smtp = new smtp($MailSet['host'],$MailSet['port'],true,$MailSet['user'],$MailSet['pass']);//这里面的一个true是表示使用身份验证,否则不使用身份验证.	$smtp->debug = false;//是否显示发送的调试信息	try{		if(!$smtp->sendmail($smtpemailto, $MailSet['user'], $subject, $content, $mailtype))		{			throw new Exception("send mail error",12345);		}	}catch(Exception $e){	}                        //        //        	$mail = new PHPMailer(); // the true param means it will throw exceptions on errors, which we need to catch                //              //		$mail->IsSMTP(); // telling the class to use SMTP//		//邮件发送//		try//		{//			//$mail->IsHTML(true);//			//$mail->SetLanguage('zh_cn');//			$mail->Priority = 1;//			$mail->Hostname = 'hjapp.com';//			//			$mail->CharSet = 'UTF-8';//			$mail->Host =$MailSet['host']; // SMTP server//			//$mail->SMTPDebug = 2;   // enables SMTP debug information (for testing)//			$mail->SMTPAuth = true;   // enable SMTP authentication//			$mail->Port = $MailSet['port'];  // set the SMTP port for the GMAIL server//			$mail->Username =$MailSet['user']; // SMTP account username//			$mail->Password =$MailSet['pass'];  // SMTP account password//			//$mail->AddReplyTo('2668176850@qq.com', 'First Last');//			$mail->AddAddress($email);//, 'Mr Dear');//			$mail->SetFrom($MailSet['user'].'@hjapp.com');//, 'service');//			$mail->Subject =$subject;//			$Body = $content;//			$mail->MsgHTML($Body);//			$mail->Send();////			if($mail->ErrorInfo != '')////			{	////				die($mail->ErrorInfo);////			}//			//$this->success("邮件已经发送，请接收！");////		}//		catch (phpmailerException $e)//		{//			$this->trace($e->errorMessage()); //Pretty error messages from PHPMailer//                       //		}//		catch (Exception $e)//		{//			$this->trace($e->errorMessage());  //Boring error messages from anything else!                       //		}                        //        //            //        	$mail = new PHPMailer(); // the true param means it will throw exceptions on errors, which we need to catch                //              //		$mail->IsSMTP(); // telling the class to use SMTP//		//邮件发送//		try//		{//			//$mail->IsHTML(true);//			//$mail->SetLanguage('zh_cn');//			//$mail->Priority = 1;//			$mail->Hostname = 'smtp.gmail.com';//			//			$mail->CharSet = 'UTF-8';//			$mail->Host =$MailSet['host']; // SMTP server//			$mail->SMTPSecure = 'ssl';//			$mail->SMTPAuth = true;   // enable SMTP authentication//			$mail->Port = $MailSet['port'];  // set the SMTP port for the GMAIL server//			$mail->Username =$MailSet['user']; // SMTP account username//			$mail->Password =$MailSet['pass'];  // SMTP account password//			//$mail->AddReplyTo('2668176850@qq.com', 'First Last');//			$mail->AddAddress($email);//, 'Mr Dear');//			$mail->SetFrom($MailSet['user']);//, 'service');//			$mail->Subject =$subject;//			$Body = $content;//			$mail->MsgHTML($Body);//			$mail->Send();////			if($mail->ErrorInfo != '')////			{	////				die($mail->ErrorInfo);////			}//			//$this->success("邮件已经发送，请接收！");////		}//		catch (phpmailerException $e)//		{//                    	$this->trace($e->errorMessage()); //Pretty error messages from PHPMailer//                      //		}//		catch (Exception $e)//		{//		      $this->trace($e->errorMessage());  //Boring error messages from anything else!                       //		}                                                                                            	//无论是否发送成功，均返成功给客户端。	echo array2json(array(		"proto" => 24,		"reqsuccess" =>  AM_REQUEST_SUCCESS,	));	if($memobj)$memobj->close();?>