<!DOCTYPE html>
<html lang="zh-cn">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=7, IE=9" />
		<link type="image/x-icon" href="__PUBLIC__/../Public/activity/image/favicon.ico" rel="icon" />
		<link type="image/x-icon" href="__PUBLIC__/../Public/activity/image/favicon.ico" rel="bookmark" />
		<title>欢聚夺宝</title>
		<meta name="generator" content="{$meta_generator}" />
		<meta name="keywords" content="{$meta_keywords}" />
		<meta name="description" content="{$meta_description}" />

		<link href="../Public/activity/main.css" rel="stylesheet" type="text/css" />
		<link href="../Public/activity/global.css" rel="stylesheet" type="text/css" />
		<link href="../Public/activity/list.css" rel="stylesheet" type="text/css" />

		<script type="text/javascript" src="__PUBLIC__/js/jquery-1.7.1.min.js"></script>
		<script type="text/javascript" src="__PUBLIC__/js/jquery.easing.1.3.js"></script>
		<script type="text/javascript" src="__PUBLIC__/js/jquery.lavalamp.min.js"></script>
		<script type='text/javascript' src="__PUBLIC__/js/artdialog/jquery.artDialog.js?skin=idialog"></script>
		<script type='text/javascript' src="__PUBLIC__/js/common.js"></script>
		<script type="text/javascript" src="__PUBLIC__/js/jquery.cycle.all.js"></script>
		<script type="text/javascript" src="__PUBLIC__/js/jquery.vticker-min.js"></script>
		<link rel="stylesheet" type="text/css" href="__PUBLIC__/js/autovalidate/style.css" />
		<script type='text/javascript' src="__PUBLIC__/js/autovalidate/validate.js"></script>
		<script type='text/javascript' src="../Public/activity/activity.js"></script>
		<script type="text/javascript">
			$(function(){
				$('.nav ul').lavaLamp({fx:'easeOutBack',speed:700});  
				$('.slides_container').cycle({ 
					speed:       800,
					timeout:     0,
					prev:   '.prev',
					next:   '.next',
					pauseOnPagerHover: true,
					pause:	true,
					cleartypeNoBg: true,

					pager:      '.pagination', 
					pagerAnchorBuilder: pagerFactory,
					fx: 'scrollHorz'
				});
				$('#sendVerify').click(function(){
					$.getJSON('{:U("Ucenter-Ajax/sendVerify")}', {mobile : $('#activity_reg_form input:[name="mobile"]').val()}, function(data){
						if(data.status == 1)
						{
							//do something...
						}
						alert(data.msg);
					});
					return false;
				});
				$('#activity_login_form input:[name="submit"]').click(function(){
					if(!check_invalid('activity_login_form', {username : 'username', password : 'password'})) return false;
					$.post(
						'{:U("Ucenter-Ajax/loginAct")}', 
						{acttype : 'duobao', username : $('#activity_login_form input:[name="username"]').val(), password : $('#activity_login_form input:[name="password"]').val()},
						function(data){
							if(data.status > 0)
							{
								if(data.synlogin)$('head').append(data.synlogin);
								window.location.reload();
								uid = data.status;
								$('.exit').html(data.html).show();
								$('.loginfo').remove();
								$('#activity_reg_form').remove();
							}
//							getDialog(data.msg);
						}, 
						'JSON'
					);
					return false;
				});
				$('#activity_reg_form input:[name="submit"]').click(function(){
					if(!check_invalid('activity_reg_form', {mobile : 'mobile', password : 'password', mobileVefiry : 'mobileVefiry', username : 'username'})) return false;
					var mobile = $('#activity_reg_form input:[name="mobile"]').val();
					var password = $('#activity_reg_form input:[name="password"]').val();
					var mobileVefiry = $('#activity_reg_form input:[name="mobileVefiry"]').val();
					var username = $('#activity_reg_form input:[name="username"]').val();
					$.post(
						'{:U("Ucenter-Ajax/regAct")}', 
						{acttype : 'duobao', mobile : mobile, password : password , mobileVefiry : mobileVefiry, username : username, acttype : 'duobao'},
						function(data){
							if(data.status == 1)
							{
//								$('#login_info').html(data.html);
//								$('#activity_login_form').remove();
//								$('#activity_reg_form').remove();
							}
							getDialog(data.msg);
						}, 
						'JSON'
					);
					return false;
				});
				$('.start_btn').live('click',function(){
					if(!$('#slidesDivTwo').html())
					{
						//$('#slidesDivTwo').html('请稍候...');
						$.getJSON('{:U("AppStore://Activity-Ajax/getUserOverview")}', function(data){
							if(data.status > 0)
							{
								$('#slidesDivTwo').html(data.html);
								goOverview();
								$('.user_dynamic').vTicker({
									speed: 500,
									pause: 3000,
									showItems: 10,
									animation: 'fade',
									mousePause: true,
									height: 170,
									direction: 'down'
								});
								var mobilesNode = $('textarea:[name="add_buddy_phone"]');
								$(document).mousemove(function(){			
									var mobileVal = mobilesNode.val().replace(/\D+/g, '');
									if(mobileVal.length > 11)
									{
										var newMobileVal = '';
										var tmp = '';
										var modTmp = parseInt(mathDiv(mobileVal.length, 11), 10);
										for(var i = 0; i <= modTmp; i ++ )
										{
											tmp = mobileVal.substr(i*11, 11);
											if(tmp.length == 11)
												newMobileVal += tmp + '\r\n';
											else
												newMobileVal += tmp;
										}
										mobilesNode.val(newMobileVal);
									}
								});
								$('.user_dynamic_tab li.user_dynamic_tab_title').each(function(i){
									$(this).hover(function(){
										$('.user_dynamic ul').hide();
										$('.user_dynamic ul').eq(i).show();
									});
								});
								validateInit();
							}
							else
							{
								alert(data.msg);
								return false;
							}
						});
					}
					else
					{
						goOverview();
					}
					return false;
				});
			});
			function pagerFactory(idx, slide) {
				return '<li></li>';
			};
			function delBuddys(id)
			{
				var ids = [];
				var idNodes = $('input:checkbox[name="buddyPhone[]"]:checked');
				var pattern = /^13[0-9]{1}[0-9]{8}$|15[0-9]{1}[0-9]{8}$|18[0-9]{1}[0-9]{8}$|147[0-9]{8}$/;

				if(pattern.test(id) == false)
				{
					idNodes.each(function(){
						ids.push($(this).val());
					});
				}
				else
				{
					ids.push(id);
				}
				if(ids.length <= 0 )
				{
					alert('请选择要删除的数据');
					return false;
				}
				
				$.dialog.confirm('确定要删除所选中的好友吗？',function(){
					$.post('{:U("AppStore://Activity-Ajax/delBuddys")}', {id : ids}, function(data){
						var tips = '';
						if(data.status == 1)
						{
							tips = 'succeed';
							if(isNaN(id))
							{
								idNodes.each(function(i){
									$('#buddy_id_'+$(this).val()).remove();
								});
							}
							else
							{
								$('#buddy_id_'+id).remove();
							}
						}
						getDialog(data.msg, tips);
					}, 'JSON')},
					function(){}
				);
				return false;
			}
			function check_invalid(form_name,mustObj)
			{
				//必填数据
				if(mustObj != '')
				{
					for(pro in mustObj)
					{
						var val = $('[name="'+form_name+'"] [name="'+mustObj[pro]+'"]').val();
						if(val == '' || val == undefined)
						{
							alert('请填写必要的数据');
							return false;
						}
					}
				}

				//数据合法性
				if($('[name="'+form_name+'"] .invalid-msg').length > 0)
				{
					alert('您填写的数据不符合规范');
					return false;
				}
				else
				{
					return true;
				}
			}
			function page(pageNum)
			{
				var listRow = $('input:[name="list_row"]').val();
				$.ajax({
					url:'{:U("AppStore://Activity-Ajax/getBuddyList")}',
					type : 'get',
					data : {pageNum : pageNum, pageSize : listRow},
					dataType:'json',
					beforeSend: function(){
						$('.buddys_list').html('请稍候...');
					},
					success:function(data) {
						if(data.status == 1)
						{
							$('.buddys_list').html(data.html);
							$('#page').html(data.pageHtml);
						}
					}
				});
			}
			function setListRow(pageSize)
			{
				var list_row_num = parseInt(pageSize);
				var list_row = $('input:[name="list_row"]').val();
				if(list_row != list_row_num)
				{
					$('input:[name="list_row"]').val(list_row_num);
					page(1);
					return;
				}
				return false;
			}
			function goOverview()
			{
				$("#slidesDivOne").animate({
					left: '-100%', opacity: 1
				}, 600, 'linear', function(){
					$(this).hide();
				});
				$("#slidesDivTwo").show().animate({
					left: '0%', opacity: 1
				}, 600, 'linear');
			}
			$('.aboutdb').bind('click', function(){
				$.getJSON('{:U("Activity-Ajax/getAboutActivity")}', function(data){
					alert(data);
				});
			});
			$('.awarddb').bind('click', function(){
				$.getJSON('{:U("Activity-Ajax/getAward")}', function(data){
					alert(data);
				});
			});
			$('.indexdb').bind('click', function(){
				$.getJSON('{:U("Activity-Ajax/getIndex")}', function(data){
					alert(data);
				});
			});
		</script>
	</head>
	<body>
	<div id="slidesDivOne" class="slidesDiv">
		<div class="wrapper">
			<div class="top" align="center">
				<img class="pic" src="../Public/activity/image/logo.gif" alt="夺宝" width="150" height="71" />
				<div class="nav" align="center">	
					<ul>
						<li class="hrefhover"><a href="javascript:void(0);" class="indexdb"><p>首页</p><p>Home</p></a></li>
						<li><a href="javascript:void(0);" class="awarddb"><p>奖品</p><p>Treasure</p></a></li>
						<li><a href="javascript:void(0);" class="aboutdb"><p>关于</p><p>About</p></a></li>
						<li><a href="http://www.hjapp.com"><p>***</p><p>Huanju</p></a></li>
					</ul>
				</div>
				<!--登录注册开始  -->	
				<compare name="userinfo['uid']" type="elt" value="0">
					{~$showLoginfo = 'display:block;';$showExit = 'display:none;';}
				<else/>
					{~$showLoginfo = 'display:none;';$showExit = 'display:block;';}
				</compare>
				<div class="loginfo" style="{$showLoginfo}">
					<div class="zhuce" style="float:right;">
						注册
						<dl id="reg">
							<form method="post" action="{:U('Ucenter-Index/loginAct')}" name="activity_reg_form" autocomplete="off" id="activity_reg_form">
								<dd style="margin-top:25px">　手机号　：<input class="input" type="text" name="mobile" value="" required /></dd>
								<dd>　密　码　：<input class="input" type="password" name="password" value="" pattern="pass" required /></dd>
								<dd>　昵　称　：<input class="input" type="text" name="username" value="" pattern="username" required /></dd>
								<dd>手机验证码：<input class="input" type="text" name="mobileVefiry" value="" pattern="verify" required /></dd>
								<dd>
									<span style="padding-right:5px"><button id="sendVerify">发送验证码</button></span>
									<input class="anniu" type="submit" name="submit" value="注册" />
								</dd>
							</form>
						</dl>
					</div>
					<div class="line">|</div>
					<div class="login">登录
						<dl id="login">
							<form method="post" action="{:U('Ucenter-Index/loginAct')}" name="activity_login_form" autocomplete="off" id="activity_login_form">
								<dd style="margin-top:20px">手机号：<input class="input" type="text" name="username" value="" required /></dd>
								<dd>密　码：<input class="input" type="password" name="password" value="" pattern="pass" required /></dd>
								<dd>
									<span>
										<input type="checkbox" name="autoLogin" />
									</span>
									<span style="padding-right:5px">记住密码</span>
									<a  style="padding-right:5px; color:#F60" href="{:U('Ucenter-Index/forgotPass', array('acttype' => 'duobao'))}">忘记密码</a>
									<input class="anniu" type="submit" name="submit" value="登录" />
								</dd>
							</form>
						</dl>
					</div>
				</div>
				<div class="exit" style="{$showExit}">
					<dl>
						<dt>
							<strong class="show_username">
								{~if(isset($userinfo['username']) && !empty($userinfo['username'])) echo $userinfo['username'];else echo $userinfo['mobile']}
							</strong>
						</dt>
						<dd class="showUpdatePassBox">
							<span onclick="updatePass();">修改密码</span>
							<dl class="updatePassBox">
								<form method="post" action="{:U('Ucenter-Ajax/updatePass')}" name="activity_updatePass_form" autocomplete="off" id="activity_updatePass_form">
									<dd style="margin-top:18px">原　密　码：<input class="input" type="password" name="pwd" pattern="pass" required /></dd>
									<dd>新　密　码：<input class="input" type="password" name="newpwd" pattern="pass" required /></dd>
									<dd>确认新密码：<input class="input" type="password" name="newrepwd" pattern="pass" required /></dd>
									<dd>
										<input class="anniu" type="submit" name="submit" value="确定" />
									</dd>
								</form>
							</dl>
						</dd>
						<dd><a href="javascript:void(0);" class="logout">退出</a></dd>
					</dl>
				</div>
				<!-- 登录结束 -->
			</div>
			<div class="outterContainer">
				<!-- layout::$viewcontent::0 -->
			</div>
		</div>
		<div class="footer1">Copyright : 2010-2012 Hjapp Rights Reserved</div>
	</div>
	<div id="slidesDivTwo" class="slidesDiv"></div>
	<script type="text/javascript">
		$('.go_activity_home').live('click',function(){
			$( "#slidesDivTwo" ).animate({
				left: '100%', opacity: 1
			}, 600, 'linear', function(){
				$(this).hide();
			});
			$('#slidesDivOne').show().animate({
				left: '0%', opacity: 1
			}, 600, 'linear');
		});
		$('input:submit[name="search"]').live('click',function() {
			var keyword = $('input:[name="keyword"]').val();
			var pageSize = $('input:[name="list_row"]').val();
			$.ajax({
				url:'{:U("AppStore://Activity-Ajax/searchBuddyList")}',
				type:'post',
				data:{keyword : keyword, pageSize : pageSize},
				dataType:'json',
				beforeSend: function(){
					$('.buddys_list').html('请稍候...');
				},
				success:function(data) {
					if(data.status == 1)
					{
						$('.buddys_list').html(data.html);
						$('#page').html(data.pageHtml);
					}
				}
			});
			return false;
		});
		$('.buddy_edit').live('click',function(){
			$(this).parent().parent().hide();
			$(this).parent().parent().next().show();
		});
		$('.buddy_cancel').live('click',function(){
			$(this).parent().parent().hide();
			$(this).parent().parent().prev().show();
		});
		$('.buddy_save').live('click',function(){
			var _this = $(this);
			var name = _this.parent().parent().find('input:text[name="buddyName"]').val();
			var newphone = _this.parent().parent().find('input:[name="buddyNewphone"]').val();
			var phone = _this.parent().parent().find('input:[name="buddyPhone"]').val();
			$.ajax({
				url:'{:U("AppStore://Activity-Ajax/editBuddy")}',
				type:'post',
				data:{ name : name, phone : phone, newphone : newphone },
				dataType:'json',
				success:function(data) {
					if(data.status == 1)
					{
						$('#buddy_id_' + phone).attr('id', 'buddy_id_'+ newphone);
						$('#buddy_id_' + newphone).find('input:[name="buddyPhone[]"]').val(newphone);
						_this.parent().parent().find('input:[name="buddyPhone"]').val(newphone);
						_this.parent().parent().prev().find('.buddy_name_td').html(name);
						_this.parent().parent().prev().find('.buddy_phone_td').html(newphone);
						_this.parent().parent().hide();
						_this.parent().parent().prev().show();
					}
					alert(data.msg);
				}
			});
		});
		$('.buddy_dels').live('click', delBuddys);
		$('.buddy_del').live('click', function(){
			var _this = $(this);
			var phone = _this.parent().parent().find('input:checkbox[name="buddyPhone[]"]').val();
			delBuddys(phone);
		});
		$('.buddy_invite').live('click', function(){
			var _this = $(this);
			var phone = _this.parent().parent().find('input:checkbox[name="buddyPhone[]"]').val();
			inviteBuddys(phone);
		});
		$('.buddy_invites').live('click', inviteBuddys);
		function inviteBuddys(id)
		{
			var ids = [];
			var idNodes = $('input:checkbox[name="buddyPhone[]"]:checked');
			var pattern = /^13[0-9]{1}[0-9]{8}$|15[0-9]{1}[0-9]{8}$|18[0-9]{1}[0-9]{8}$|147[0-9]{8}$/;

			if(pattern.test(id) == false)
			{
				idNodes.each(function(){
					ids.push($(this).val());
				});
			}
			else
			{
				ids.push(id);
			}
			if(ids.length <= 0 )
			{
				alert('请选择要邀请的好友！');
				return false;
			}
			$.post('{:U("AppStore://Activity-Ajax/adviseBuddy")}', {phone : ids}, function(data){
				alert(data.msg);
			}, 'JSON');
		}
		$('.buddy_vote').live('click', function(){
			var _this = $(this);
			var phone = _this.parent().parent().find('input:checkbox[name="buddyPhone[]"]').val();
			voteBuddys(phone);
		});
		$('.buddy_votes').live('click', voteBuddys);
		function voteBuddys(id)
		{
			var ids = [];
			var idNodes = $('input:checkbox[name="buddyPhone[]"]:checked');
			var pattern = /^13[0-9]{1}[0-9]{8}$|15[0-9]{1}[0-9]{8}$|18[0-9]{1}[0-9]{8}$|147[0-9]{8}$/;

			if(pattern.test(id) == false)
			{
				idNodes.each(function(){
					ids.push($(this).val());
				});
			}
			else
			{
				ids.push(id);
			}
			if(ids.length <= 0 )
			{
				alert('请选择要邀请的好友！');
				return false;
			}
			$.post('{:U("AppStore://Activity-Ajax/voteBuddy")}', {id : ids}, function(data){
				alert(data.msg);
			}, 'JSON');
		}
		$('.selectPhoneBook').live('click', function(){
			$.dialog.open('{:U("Activity-Test/guestPhoneBook")}',{id:'guest_phone_book',title:'上传好友列表'});
		});
		$('.logout').live('click', function(){
			$.getJSON("{:U('Ucenter-Ajax/logout')}", function(data){
				if(data.status == 1)
				{
					if(data.synlogout)$('head').append(data.synlogout);
					window.location.reload();
				}
			});
		});
		$('#activity_updatePass_form input:[name="submit"]').live('click', function(){
			if(!check_invalid('activity_updatePass_form', {pwd : 'pwd', newpwd : 'newpwd', newrepwd : 'newrepwd'})) return false;
			var obj = {
				acttype : 'duobao', 
				pwd : $('#activity_updatePass_form input:[name="pwd"]').val(),
				newpwd : $('#activity_updatePass_form input:[name="newpwd"]').val(), 
				newrepwd : $('#activity_updatePass_form input:[name="newrepwd"]').val()
			};
			doUpdatePass(obj);
			return false;
		});
		$('#overview_updatePass_form input:[name="submit"]').live('click', function(){
			if(!check_invalid('overview_updatePass_form', {pwd : 'pwd', newpwd : 'newpwd', newrepwd : 'newrepwd'})) return false;
			var obj = {
				acttype : 'duobao', 
				pwd : $('#overview_updatePass_form input:[name="pwd"]').val(),
				newpwd : $('#overview_updatePass_form input:[name="newpwd"]').val(), 
				newrepwd : $('#overview_updatePass_form input:[name="newrepwd"]').val()
			};
			doUpdatePass(obj);
			return false;
		});
		$('.huigu').live('click', function(){
			$('.content1 .pic').slideToggle("fast");
		});
		function doUpdatePass(obj)
		{
			$.post(
				'{:U("Ucenter-Ajax/updatePass")}', 
				obj,
				function(data){
					data.status == 1 ? getDialog(data.msg, 'succeed', true) : getDialog(data.msg);
				}, 
				'JSON'
			);
		}
		function callbackPhoneBook(content)
		{
			var content = eval(content);
			if(content.isError == true)
			{
				alert(content.message);
			}
			else
			{
				page(1);
			}
			$.dialog({id:'guest_phone_book'}).close();
		}
		$('.buddy_add_btn').live('click', function(){
			$.dialog({
				id : 'buddy_add_dialog',
				content : document.getElementById('show_buddy_add_box')//$('.buddy_add_box').html()
			});
			return false;
		});

		/*除法函数，用来得到精确的除法结果
		 *返回值：arg1除以arg2的精确结果
		 */
		function mathDiv(arg1,arg2)
		{
			var t1=0,t2=0,r1,r2;
			try{t1=arg1.toString().split(".")[1].length}catch(e){}
			try{t2=arg2.toString().split(".")[1].length}catch(e){}
			with(Math){
				r1=Number(arg1.toString().replace(".",""));
				r2=Number(arg2.toString().replace(".",""));
				return (r1/r2)*pow(10,t2-t1);
			}
		}
		$('.buddy_add').live('click', function(){
			var mobilesNode = $('textarea:[name="add_buddy_phone"]');
			var mobileVal = $.trim(mobilesNode.val()).replace(/\s+/g, '#');
			var mobileArr = mobileVal.split('#');			
			//mobileArr = $.unique(mobileArr);
			if(mobileArr.length > 20)
			{
				getDialog('每次最多只能邀请20个好友', 'error', false);
				return false;
			}
			for(var i = 0; i < mobileArr.length; i ++)
			{
				var pattern = /^13[0-9]{1}[0-9]{8}$|15[0-9]{1}[0-9]{8}$|18[0-9]{1}[0-9]{8}$|147[0-9]{8}$/;
				if(pattern.test(mobileArr[i]) == false)
				{
					getDialog(mobileArr[i] + '<br />此手机号不合法<br />请填写合法的手机号！', 'error', false, 5);
					return false;
				}
			}
			var add_invite = $('input:checkbox[name="add_invite"]:checked').val() ? 1 : 0;
			$.post(
				'{:U("AppStore://Activity-Ajax/addBuddy")}',
				{phone : mobileVal, buddyName : '', add_invite : add_invite},
				function(data){
					if(data.status > 0)
					{
						$.dialog({id:'buddy_add_dialog'}).close();
						page(1);
					}
					alert(data.msg);
				},
				'JSON'
			);
		});
		$('input:text[name="keyword"]').live({
			focus:function(){checkInput($(this), '请输入想要查询的好友手机号...');},
			blur :function(){checkInput($(this), '请输入想要查询的好友手机号...');}
		});
		function checkInput(para,textVal)
		{
			var inputObj = (typeof(para) == 'object') ? para : $('#'+para+'');

			if(inputObj.val() == '')
			{
				inputObj.val(textVal);
			}
			else if(inputObj.val() == textVal)
			{
				inputObj.val('');
			}
		}
	</script>
</body>
</html>